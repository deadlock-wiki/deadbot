name: Auto Deploy

on:
  schedule:
    - cron: '*/30 * * * *'

  workflow_dispatch:
    inputs:
      english-only:
        type: boolean
        description: Only parse English localizations
        default: false
      
      force:
        type: boolean
        description: Run deployments even if version has not changed
        default: false

jobs:
  check-update:
    name: Check for new version
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.check_version.outputs.new_version }}
    steps:
      - name: Checkout Deadbot repo
        uses: actions/checkout@v4
        with:
          repository: deadlock-wiki/deadbot

      - name: Checkout SteamDB repo
        uses: actions/checkout@v4
        with: 
          repository: SteamDatabase/GameTracking-Deadlock
          ref: master
          path: steamdb
          token:  ${{ secrets.GH_TOKEN }} 

      - name: Checkout deadlock-data repo
        uses: actions/checkout@v4
        with:
          repository: deadlock-wiki/deadlock-data
          ref: master
          path: deadlock-data
          token:  ${{ secrets.GH_TOKEN }}   

      - name: Check for new Deadlock version
        id: check_version
        run: |
          chmod +x ./.github/workflows/scripts/check_for_update.sh
          new_version=$(./.github/workflows/scripts/check_for_update.sh './steamdb' './deadlock-data')
          echo "new_version=$new_version" >> $GITHUB_OUTPUT

  deploy-develop:
    name: Deploy develop
    runs-on: ubuntu-latest
    needs: check-update
    if: ${{ needs.check-update.outputs.new_version || github.event.inputs.force == 'true' }}
    steps:
      run: echo DEBUG ${{ needs.check-update.outputs.new_version }}
  #   uses: ./.github/workflows/deploy.yaml
  #   with:
  #     branch-override: develop
  #     english-only: ${{ github.event.inputs.english-only == 'true' }}
  #   secrets:
  #     GH_TOKEN: ${{ secrets.GH_TOKEN }}
  #     STEAM_USERNAME: ${{ secrets.STEAM_USERNAME }}
  #     STEAM_PASSWORD: ${{ secrets.STEAM_PASSWORD }}
  #     BOT_WIKI_USER: ${{ secrets.BOT_WIKI_USER }}
  #     BOT_WIKI_PASS: ${{ secrets.BOT_WIKI_PASS }}
  
  # deploy-master:
  #   name: Deploy master
  #   needs: check-update
  #   if: ${{ needs.check-update.outputs.new_version || github.event.inputs.force == 'true' }}
  #   uses: ./.github/workflows/deploy.yaml
  #   with:
  #     branch-override: master
  #     english-only: ${{ github.event.inputs.english-only == 'true' }}
  #   secrets:
  #     GH_TOKEN: ${{ secrets.GH_TOKEN }}
  #     STEAM_USERNAME: ${{ secrets.STEAM_USERNAME }}
  #     STEAM_PASSWORD: ${{ secrets.STEAM_PASSWORD }}
  #     BOT_WIKI_USER: ${{ secrets.BOT_WIKI_USER }}
  #     BOT_WIKI_PASS: ${{ secrets.BOT_WIKI_PASS }}
